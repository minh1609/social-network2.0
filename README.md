# Technical Document

#### For future references

## Demonstration

![picture](./blog.gif)

## Authentication process step by step

-   User clicks "Log in with Google" button
-   Redirect user to Google Authentication flow, enter gmail and password
-   After enter the correct email, password, redirect user to /auth/google/callback route
-   Server receive user profile from google, take their google id, if this google id does not exist in database => create new user
-   Server set a pair of cookies (called **express:sess** and **express:sess.sig**) which contain user information to browser

    ![alt text](./cookie.png)

*   Whenever user send a request, that cookies always come with the request, help server identifies who make the request (or whoever has this pair of cookie in their browser is counted as authenticated user)

## What is the meaning of a long string inside cookie ?

_(this app using "passport" and "cookie-session" to manage authentication)_

> express:sess: eyJwYXNzcG9ydCI6eyJ1c2VyIjoiNWQxNmU1NDM5ZWEwYmIyZWEwMmRkM2Y0In19

> express:sess.sig: Mgc2MrAFKnWx5oXz9jUZOFnKkEk

**express:sess**
Using "safe-buffer" package, we can convert this long string from base64 to utf8. After conversion, it become something like this

```javascript
passport: {
    user: 5d19b2cd289ebc0c48eecb29
}
//5d19b2cd289ebc0c48eecb29 is object id auto generated by mongoDB
```

==> express:sess created from user id

**express:sess.sig**
(improve security for cookie)

Using "keygrip" package, value of express:sess, and a key I set for cookie-session(key for encrypting cookie), we get the value for express:sess.sig

```javascript
const session =
    "eyJwYXNzcG9ydCI6eyJ1c2VyIjoiNWQxNmU1NDM5ZWEwYmIyZWEwMmRkM2Y0In19";
const Keygrip = require("keygrip");
const keygrip = new Keygrip(["123123123"]);
keygrip.sign("express:sess=" + session);
//"Mgc2MrAFKnWx5oXz9jUZOFnKkEk"
```

## Testing by jess, puppeteer

### Bypass authentication when testing

#### Easy way

Get value of express:sess and express:sess.sig from user who already log in, set cookie for testing page

```javascript
logIn = async page => {
    await page.setCookie({
        name: "express:sess",
        value:
            "eyJwYXNzcG9ydCI6eyJ1c2VyIjoiNWQxNmU1NDM5ZWEwYmIyZWEwMmRkM2Y0In19"
    });
    await page.setCookie({
        name: "express:sess.sig",
        value: "Mgc2MrAFKnWx5oXz9jUZOFnKkEk"
    });
    await page.goto("http://localhost:3000");
};
```

pros: fast\
cons: does not work on different database (ci environment use different database, diffrent encrytion key)

#### Difficult way

-   Create new user
-   Get this user id
-   From this id, created new set of cookie by using "keygrip" and "safe-buffer" packages
-   Set this cookie to browser

pros: work with any database\
cons: write more code

## Test cases

-   User log in
    -   Can see a blog create form
    -   Enter valid input to create blog
    -   Enter invalid input to create blog
-   User not log in
    -   Can not make get, post request to server

## Redis with Mongoose

Over write exec( ) function in Mongoose Query Object, before retrieve data from DataBase, go to Redis server first, see if data needed already exists inside Redis or not

-   If yes, get this data, do not go to MongoDB
-   If no, go to MongoDB, get data, then save it to Redis

**Note**:

-   Do not cache all data
-   Delete cached data if this data has been modified
